<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VMC Test Console</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #0f172a;
      color: #e5e7eb;
      cursor: none;        /* hide mouse */
      user-select: none;   /* disable text selection */
    }
    ::-webkit-scrollbar { display:none; }
    h1 {
      margin-top: 0;
      font-size: 20px;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    #status {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
    }
    .status-ok { background: #16a34a33; color: #bbf7d0; }
    .status-bad { background: #b91c1c33; color: #fecaca; }
    .status-warn { background: #ca8a0433; color: #facc15; }

    button {
      background: #f97316;
      border: none;
      color: #0f172a;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #ea580c;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    #slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }
    .slot-card {
      background: #020617;
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #1e293b;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .slot-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.45);
      border-color: #f97316;
    }
    .slot-card.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      border-color: #1f2937;
      box-shadow: none;
    }
    .slot-card.disabled:hover {
      transform: none;
      box-shadow: none;
      border-color: #1f2937;
    }

    .slot-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
      font-size: 13px;
      color: #e5e7eb;
    }
    .slot-selection {
      font-weight: 600;
    }
    .slot-price {
      font-weight: 600;
      color: #f97316;
    }
    .slot-meta {
      font-size: 11px;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
    }
    .slot-status-bad {
      color: #fecaca;
      font-weight: 600;
    }

    .slot-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
    }
    .chip {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 10px;
      border: 1px solid #1e293b;
    }
    .chip-ok {
      border-color: #16a34a;
      color: #bbf7d0;
    }
    .chip-bad {
      border-color: #b91c1c;
      color: #fecaca;
    }

    .btn-small {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    .btn-small:hover {
      background: #1f2937;
    }
    .btn-small:disabled {
      opacity: 0.4;
      cursor: default;
    }

    #log {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1e293b;
      padding: 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      max-height: 260px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    #log-title {
      font-size: 13px;
      margin-bottom: 4px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <h1>VMC Test Console</h1>
    <div id="status" class="status-warn">Connectingâ€¦</div>
    <button id="btnRefresh">Get slots</button>
    <button id="btnFull">Fullscreen</button>
  </div>

  <div id="slots"></div>

  <div id="log-container">
    <div id="log-title">Event log</div>
    <div id="log"></div>
  </div>

  <script>
    const btnFull = document.getElementById("btnFull");

    // request fullscreen
    function enterFull() {
    const el = document.documentElement;
    if (el.requestFullscreen) el.requestFullscreen();
    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }

    // try fullscreen on load (browser may ask one click)
    document.addEventListener("click", () => {
    if (!document.fullscreenElement) enterFull();
    });

    btnFull.onclick = enterFull;

    // ðŸ‘‰ CHANGE THIS TO YOUR SERVER ADDRESS IF NEEDED
    const WS_URL = "ws://192.168.8.171:5000/ws/vmc";

    const statusEl = document.getElementById("status");
    const btnRefresh = document.getElementById("btnRefresh");
    const slotsEl = document.getElementById("slots");
    const logEl = document.getElementById("log");

    let ws = null;
    let slots = {}; // selection -> last slot_info

    function setStatus(text, cls) {
      statusEl.textContent = text;
      statusEl.className = cls;
    }

    function appendLog(line) {
      const ts = new Date().toLocaleTimeString();
      logEl.textContent += `[${ts}] ${line}\n`;
      const lines = logEl.textContent.split("\n");
      if (lines.length > 400) {
        logEl.textContent = lines.slice(lines.length - 400).join("\n");
      }
      logEl.scrollTop = logEl.scrollHeight;
    }

    function connect() {
      appendLog(`Connecting to ${WS_URL} â€¦`);
      setStatus("Connectingâ€¦", "status-warn");
      btnRefresh.disabled = true;

      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        appendLog("WS connected");
        setStatus("Connected", "status-ok");
        btnRefresh.disabled = false;
        requestSlots(); // auto on connect
      };

      ws.onmessage = (ev) => {
        let msg;
        try {
          msg = JSON.parse(ev.data);
        } catch (err) {
          appendLog("RX (raw): " + ev.data);
          return;
        }
        handleEvent(msg);
      };

      ws.onclose = () => {
        appendLog("WS closed");
        setStatus("Disconnected", "status-bad");
        btnRefresh.disabled = true;
      };

      ws.onerror = (err) => {
        appendLog("WS error: " + err);
        setStatus("Error", "status-bad");
      };
    }

    function sendMessage(obj) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        appendLog("Cannot send, WS not connected");
        return;
      }
      const s = JSON.stringify(obj);
      ws.send(s);
      appendLog("TX: " + s);
    }

    function requestSlots() {
      slots = {};
      renderSlots();
      sendMessage({ type: "get_slots" });
    }

    function handleEvent(msg) {
      if (msg.event === "slot_info") {
        slots[msg.selection] = msg;
        renderSlots();
        appendLog(
          `RX slot_info sel=${msg.selection} price=${msg.price} inv=${msg.inventory}/${msg.capacity} status=${msg.status}`
        );
        return;
      }

      if (msg.event === "vend_status") {
        appendLog(
          `RX vend_status sel=${msg.selection} status=${msg.status}`
        );
        return;
      }

      if (msg.event === "command_sent") {
        appendLog(
          `TX CMD ${msg.cmd} comm=${msg.comm_no} retries=${msg.retries}`
        );
        return;
      }

      if (msg.event === "command_finished") {
        appendLog(
          `Command finished ${msg.cmd} comm=${msg.comm_no}`
        );
        return;
      }

      if (msg.event === "command_timeout") {
        appendLog(
          `Command TIMEOUT ${msg.cmd} comm=${msg.comm_no}`
        );
        return;
      }

      if (msg.event === "error") {
        appendLog("ERROR: " + msg.error);
        return;
      }

      // fallback for everything else
      appendLog("RX: " + JSON.stringify(msg));
    }

    function renderSlots() {
      slotsEl.innerHTML = "";
      const selections = Object.keys(slots)
        .map(Number)
        .sort((a, b) => a - b);
      if (!selections.length) {
        slotsEl.innerHTML =
          '<div style="color:#9ca3af;font-size:13px;">No slots loaded yet.</div>';
        return;
      }

      for (const sel of selections) {
        const s = slots[sel];
        const card = document.createElement("div");
        const price = s.price || 0;
        const inv = s.inventory ?? "?";
        const cap = s.capacity ?? "?";
        const status = s.status ?? 0;

        // Your rule: only allow buy if product status == 1
        const isEnabled = status === 0;

        card.className = "slot-card" + (isEnabled ? "" : " disabled");
        card.dataset.selection = sel;

        const statusLabel = isEnabled ? "OK" : `ST: ${status}`;

        card.innerHTML = `
          <div class="slot-header">
            <div class="slot-selection">Slot ${sel}</div>
            <div class="slot-price">${(price / 100).toFixed(2)}</div>
          </div>
          <div class="slot-meta">
            <span>Inv: ${inv}/${cap}</span>
            <span class="${isEnabled ? "chip chip-ok" : "chip chip-bad"}">
              ${statusLabel}
            </span>
          </div>
          <div class="slot-actions">
            <button class="btn-small btn-buy">Buy</button>
            <button class="btn-small btn-direct">Direct vend</button>
          </div>
        `;

        const btnBuy = card.querySelector(".btn-buy");
        const btnDirect = card.querySelector(".btn-direct");

        if (!isEnabled) {
          // disable both actions
          btnBuy.disabled = true;
          btnDirect.disabled = true;
        } else {
          // main click = buy
          card.addEventListener("click", (e) => {
            // avoid double trigger when clicking on the small buttons
            if (e.target === btnBuy || e.target === btnDirect) return;
            onBuyClick(sel);
          });

          btnBuy.addEventListener("click", (e) => {
            e.stopPropagation();
            onBuyClick(sel);
          });

          btnDirect.addEventListener("click", (e) => {
            e.stopPropagation();
            onDirectVendClick(sel);
          });
        }

        slotsEl.appendChild(card);
      }
    }

    function onBuyClick(selection) {
      const ok = confirm(`Send BUY command for slot ${selection}?`);
      if (!ok) return;
      sendMessage({
        type: "buy",
        selection: selection
      });
    }

    // keep direct_vend available in JS and UI
    function onDirectVendClick(selection) {
      const ok = confirm(`Send DIRECT VEND for slot ${selection}?`);
      if (!ok) return;
      sendMessage({
        type: "direct_vend",
        selection: selection,
        use_drop_sensor: true,
        use_elevator: true,
        shopping_cart: false
      });
    }

    // --- wire UI ---
    btnRefresh.addEventListener("click", requestSlots);

    // connect on page load
    connect();
  </script>
</body>
</html>
